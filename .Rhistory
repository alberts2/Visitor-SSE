percent_df$vis_vis[i] = (sum_vis_vis_i/(sum_res_res_i+sum_res_vis_i+sum_vis_res_i+sum_vis_vis_i))*100
}
# Plotting
plot_dat = data.frame(value = rep(NA,564*4),
type = rep(c("res-res","res-vis","vis-res","vis-vis"),each = 564))
plot_dat[1:564,1]     = percent_df$res_res
plot_dat[565:1128,1]  = percent_df$res_vis
plot_dat[1129:1692,1] = percent_df$vis_res
plot_dat[1693:2256,1] = percent_df$vis_vis
########### CLADO MIGRATION ################
####### File System #######
##########################
fp = "/Users/albertsoewongsono/Documents/Code Testing/visitor_sse"
in_fp = paste0(fp,"/output/logs/full/clado_migration_unequal_burnin") #unequal clado migration with burn in
####### Initialize #######
##########################
# Store posterior mean rate and posterior mean count for each event
compare_dat = compare_dat <- data.frame(
type = c("within-location", "between-location"),
posterior_mean_count = rep(NA,2)
)
#
clado_migration_rev = c(0,0,0,0,0,1,0,1,0,0,0,2,0,2,0,0,0,3,0,3,0,0,0,4,0,4,0,1,1,0,1,0,1,1,1,1,1,1,2,1,2,1,1,1,3,1,3,1,1,1,4,1,4,1,2,2,0,2,0,2,2,2,1,2,1,2,2,2,2,2,2,3,2,3,2,2,2,4,2,4,2,3,3,0,3,0,3,3,3,1,3,1,3,3,3,2,3,2,3,3,3,3,3,3,4,3,4,3,4,4,0,4,0,4,4,4,1,4,1,4,4,4,2,4,2,4,4,4,3,4,3,4,4,4,4)
branching_event_df = data.frame(end_parent = NA, start_child_1 = NA, start_child_2 = NA)
for (i in 1:45){
parent_state = clado_migration_rev[(i-1)*3+1] #parent's state
child1_state = clado_migration_rev[(i-1)*3+2] #child1's state
child2_state = clado_migration_rev[i*3] #child2's state
#
rows_added = c(parent_state,child1_state,child2_state)
#
branching_event_df[i,] = rows_added
}
#read the stoch mapping for the full tree under visitor model
stoch_dat = read.table(paste0(in_fp,"/out._fullclado.seed_5.stoch_summ.tsv"),sep = "\t",header = T)
#sort by MCMC iteration
stoch_dat_sort = stoch_dat[order(stoch_dat$iteration),]
#list of all unique mcmc iterations
iteration_vec = unique(stoch_dat_sort$iteration)
#
count_dat = cbind(branching_event_df,
count = rep(0,nrow(branching_event_df)))
count_dat$count <- replicate(nrow(count_dat), rep(0,length(iteration_vec)), simplify = FALSE)
for (j in 1:length(iteration_vec)){ # loop over each MCMC sample (each ancestral state history)
# j = 195
stoch_dat_j = stoch_dat_sort[stoch_dat_sort$iteration == iteration_vec[j],] # look for the whole history for sampled history j
#
parent_dat_j = stoch_dat_j[!is.na(stoch_dat_j$child1_index) & !is.na(stoch_dat_j$child2_index),] # find all parent nodes (the ones that have children lineages)
all_parent_ind = unique(parent_dat_j$node_index) # find all parent node indices for history j
for (k in 1:length(all_parent_ind)){ # loop over each parent index for history j
node_parent_dat_j = parent_dat_j[parent_dat_j$node_index==all_parent_ind[k],] # find all events on the parent edge with node index k
last_event_parent_j = node_parent_dat_j[nrow(node_parent_dat_j), ] # get the last event on that parent edge with node index k
if (last_event_parent_j$transition_type == "anagenetic"){
end_state_parent_j = last_event_parent_j$end_state # get the end state before branching for that parent node k
} else {
end_state_parent_j = last_event_parent_j$start_state # get the end state before branching for that parent node k
}
# get history for children nodes originated from parent node k
child_1_stoch_j = stoch_dat_j[stoch_dat_j$node_index == last_event_parent_j$child1_index,]
child_2_stoch_j = stoch_dat_j[stoch_dat_j$node_index == last_event_parent_j$child2_index,]
# get the start state of both children (always the first row on child_1_stoch_j and child_2_stoch_j)
start_state_child_1 = child_1_stoch_j[1,]$start_state
start_state_child_2 = child_2_stoch_j[1,]$start_state
# Record the parent_state and child_state combination for that particular parent index k for history j
count_dat[count_dat$end_parent == end_state_parent_j & count_dat$start_child_1 == start_state_child_1 & count_dat$start_child_2 == start_state_child_2,]$count[[1]][j] =
count_dat[count_dat$end_parent == end_state_parent_j & count_dat$start_child_1 == start_state_child_1 & count_dat$start_child_2 == start_state_child_2,]$count[[1]][j] + 1
}
print(paste0("done iteration ",iteration_vec[j]))
}
count_dat$infection_type <- rep(NA,45)
for (i in 1:45){
if (count_dat[i,]$end_parent == count_dat[i,]$start_child_1 && count_dat[i,]$start_child_1 == count_dat[i,]$start_child_2){ #within-loc
count_dat[i,"infection_type"] = "within_loc"
} else {
count_dat[i,"infection_type"] = "between_loc"
}
}
# all within-loc infection counts
within_dat  <- count_dat[count_dat$infection_type == "within_loc",]
# all between-loc infection counts
between_dat <- count_dat[count_dat$infection_type == "between_loc",]
# Get the percentage of events at each iteration
percent_df <- data.frame(within_loc  = rep(NA,564),
between_loc = rep(NA,564))
for (i in 1:564){ #loop over each iteration
sum_within_i  = sum(sapply(within_dat$count, function(x) x[i]))
sum_between_i = sum(sapply(between_dat$count, function(x) x[i]))
#
percent_df$within_loc[i]  = (sum_within_i/(sum_within_i + sum_between_i))*100
percent_df$between_loc[i] = (sum_between_i/(sum_within_i + sum_between_i))*100
}
# Plotting
plot_dat_migration = data.frame(value = rep(NA,564*2),
type = rep(c("within_loc","between_loc"),each = 564))
plot_dat_migration[1:564,1]     = percent_df$within_loc
plot_dat_migration[565:1128,1]  = percent_df$between_loc
View(plot_dat_migration)
View(plot_dat)
plot_combined_within = rbind(plot_dat[plot_dat$type=="res-res",],plot_dat_migration[plot_dat_migration$type=="within_loc",])
View(plot_combined_within)
plot_combined_between = rbind(plot_dat[plot_dat$type=="res-vis",],
plot_dat[plot_dat$type=="vis-res",],
plot_dat[plot_dat$type=="vis-vis",],
plot_dat_migration[plot_dat_migration$type=="between_loc",])
View(plot_combined_between)
p_within = ggplot(plot_combined_within, aes(x = type, y = value,fill = type)) +
geom_violin(position = position_dodge(width = 0.9), trim = FALSE,scale="width") +
theme_minimal() +
labs(x = "Infection type", y = "Percentage",fill = "Infection type") +
scale_fill_manual(values = c("within_loc" = "#CDC9C9","res-res" = "#FFAEB9"))+
theme(axis.text.x = element_text(size = 18),   # x-axis tick labels
axis.text.y = element_text(size = 20),   # y-axis tick labels
axis.title.x = element_text(size = 20),  # x-axis title
axis.title.y = element_text(size = 20),  # y-axis title
legend.text = element_text(size = 16),   # legend item labels
legend.title = element_text(size = 16))
p_within
plot_combined_within$type  <- factor(plot_combined_within$type, levels = c("within_loc","res-res"))
plot_combined_between$type <- factor(plot_combined_between$type, levels = c("between_loc","res-vis","vis-res","vis-vis"))
p_within = ggplot(plot_combined_within, aes(x = type, y = value,fill = type)) +
geom_violin(position = position_dodge(width = 0.9), trim = FALSE,scale="width") +
theme_minimal() +
labs(x = "Infection type", y = "Percentage",fill = "Infection type") +
scale_fill_manual(values = c("within_loc" = "#CDC9C9","res-res" = "#FFAEB9"))+
theme(axis.text.x = element_text(size = 18),   # x-axis tick labels
axis.text.y = element_text(size = 20),   # y-axis tick labels
axis.title.x = element_text(size = 20),  # x-axis title
axis.title.y = element_text(size = 20),  # y-axis title
legend.text = element_text(size = 16),   # legend item labels
legend.title = element_text(size = 16))
p_within
p_between = ggplot(plot_combined_between, aes(x = type, y = value,fill = type)) +
geom_violin(position = position_dodge(width = 0.9), trim = FALSE,scale="width") +
theme_minimal() +
labs(x = "Infection type", y = "Percentage",fill = "Infection type") +
scale_fill_manual(values = c("between_loc" = "#CDC9C9","res-vis" = "#FFAEB9", "vis-res" = "#00EEEE","vis-vis" = "#CD950C"))+
theme(axis.text.x = element_text(size = 18),   # x-axis tick labels
axis.text.y = element_text(size = 20),   # y-axis tick labels
axis.title.x = element_text(size = 20),  # x-axis title
axis.title.y = element_text(size = 20),  # y-axis title
legend.text = element_text(size = 16),   # legend item labels
legend.title = element_text(size = 16))
p_between
ggsave(paste0(plot_fp, "/summary_posterior_count_within",".pdf"),p_within, height = 10, width = 15)
ggsave(paste0(plot_fp, "/summary_posterior_count_between",".pdf"),p_between, height = 10, width = 15)
View(p_within)
View(plot_combined_within)
?geom_violin
ggsave(paste0(plot_fp, "/summary_posterior_count_within",".pdf"),p_within, height = 10, width = 15)
ggsave(paste0(plot_fp, "/summary_posterior_count_between",".pdf"),p_between, height = 10, width = 15)
p_between = ggplot(plot_combined_between, aes(x = type, y = value,fill = type)) +
geom_violin(position = position_dodge(width = 0.9), trim = FALSE) +
theme_minimal() +
labs(x = "Infection type", y = "Percentage",fill = "Infection type") +
scale_fill_manual(values = c("between_loc" = "#CDC9C9","res-vis" = "#FFAEB9", "vis-res" = "#00EEEE","vis-vis" = "#CD950C"))+
theme(axis.text.x = element_text(size = 18),   # x-axis tick labels
axis.text.y = element_text(size = 20),   # y-axis tick labels
axis.title.x = element_text(size = 20),  # x-axis title
axis.title.y = element_text(size = 20),  # y-axis title
legend.text = element_text(size = 16),   # legend item labels
legend.title = element_text(size = 16))
p_between
p_within = ggplot(plot_combined_within, aes(x = type, y = value,fill = type)) +
geom_violin(position = position_dodge(width = 0.9), trim = FALSE) +
theme_minimal() +
labs(x = "Infection type", y = "Percentage",fill = "Infection type") +
scale_fill_manual(values = c("within_loc" = "#CDC9C9","res-res" = "#FFAEB9"))+
theme(axis.text.x = element_text(size = 18),   # x-axis tick labels
axis.text.y = element_text(size = 20),   # y-axis tick labels
axis.title.x = element_text(size = 20),  # x-axis title
axis.title.y = element_text(size = 20),  # y-axis title
legend.text = element_text(size = 16),   # legend item labels
legend.title = element_text(size = 16))
p_within
# save plot
ggsave(paste0(plot_fp, "/summary_posterior_count_within",".pdf"),p_within, height = 10, width = 15)
ggsave(paste0(plot_fp, "/summary_posterior_count_between",".pdf"),p_between, height = 10, width = 15)
library(ggplot2)
library(HDInterval)
########
fp = "/Users/albertsoewongsono/Documents/Code Testing/visitor_sse"
# using unequal rates models with empirical priors on sampling proportions and movements. (with burnin)
in_fp_visitor      = paste0(fp, "/output/logs/full/visitor_unequal_new_priors_burnin/")
in_fp_cladomigrate = paste0(fp, "/output/logs/full/clado_migration_unequal_burnin/")
# # using unequal rates models with empirical priors on sampling proportions and movements.
# # for this one, visitor does not have burn-in and has mixing problem
# in_fp_visitor      = paste0(fp, "/output/logs/full/visitor_unequal_rates_new_priors/")
# in_fp_cladomigrate = paste0(fp, "/output/logs/full/clado_migration_unequal_rates_new_priors/")
# # Using equal rates models with empirical priors on sampling proportions and movements
# in_fp_visitor      = paste0(fp, "/output/logs/full/visitor_equal_rates_new_priors/")
# in_fp_cladomigrate = paste0(fp, "/output/logs/full/clado_migration_equal_rates_new_priors/")
# # Unequal models with emp priors on movements and fixed sampling
# in_fp_visitor      = paste0(fp, "/output/logs/full/visitor_unequal_rates_fixed_sampling/")
# in_fp_cladomigrate = paste0(fp, "/output/logs/full/clado_migration_unequal_fixed_sampling/")
# # Unequal models with where movement rates are independent of away locations with emp priors on move and sampling
# in_fp_visitor      = paste0(fp, "/output/logs/full/visitor_unequal_new_priors_rows/")
# in_fp_cladomigrate = paste0(fp, "/output/logs/full/clado_migration_unequal_rows/")
#
plot_fp = paste0(fp, "/scripts/plot")
##############
# DATA #
##############
log_visitor = paste0(in_fp_visitor, "out._full.seed_5.model.log")
log_clado   = paste0(in_fp_cladomigrate, "out._fullclado.seed_5.model.log")
dat_visitor = read.table(log_visitor,header = TRUE, sep = "", stringsAsFactors = FALSE)
dat_clado   = read.table(log_clado,header = TRUE, sep = "", stringsAsFactors = FALSE)
dat_visitor = dat_visitor[dat_visitor$Iteration > 1875,] # remove 25% burn-in samples
dat_clado   = dat_clado[dat_clado$Iteration > 1875,] # remove 25% burn-in samples
#######
locs_vec = c("Hubei","France", "Germany","Italy","OtherEU")
# clado events for visitor model from revbayes script (ordered)
clado_visitor_rev = c(0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,0,5,0,5,6,6,1,6,1,6,7,7,2,7,2,7,8,8,3,8,3,8,9,9,4,9,4,9,10,10,0,10,0,10,11,11,1,11,1,11,12,12,2,12,2,12,13,13,3,13,3,13,14,14,4,14,4,14,15,15,0,15,0,15,16,16,1,16,1,16,17,17,2,17,2,17,18,18,3,18,3,18,19,19,4,19,4,19,20,20,0,20,0,20,21,21,1,21,1,21,22,22,2,22,2,22,23,23,3,23,3,23,24,24,4,24,4,24,0,0,5,0,5,0,1,1,6,1,6,1,2,2,7,2,7,2,3,3,8,3,8,3,4,4,9,4,9,4,5,5,5,6,6,6,7,7,7,8,8,8,9,9,9,10,10,5,10,5,10,11,11,6,11,6,11,12,12,7,12,7,12,13,13,8,13,8,13,14,14,9,14,9,14,15,15,5,15,5,15,16,16,6,16,6,16,17,17,7,17,7,17,18,18,8,18,8,18,19,19,9,19,9,19,20,20,5,20,5,20,21,21,6,21,6,21,22,22,7,22,7,22,23,23,8,23,8,23,24,24,9,24,9,24,0,0,10,0,10,0,1,1,11,1,11,1,2,2,12,2,12,2,3,3,13,3,13,3,4,4,14,4,14,4,5,5,10,5,10,5,6,6,11,6,11,6,7,7,12,7,12,7,8,8,13,8,13,8,9,9,14,9,14,9,10,10,10,11,11,11,12,12,12,13,13,13,14,14,14,15,15,10,15,10,15,16,16,11,16,11,16,17,17,12,17,12,17,18,18,13,18,13,18,19,19,14,19,14,19,20,20,10,20,10,20,21,21,11,21,11,21,22,22,12,22,12,22,23,23,13,23,13,23,24,24,14,24,14,24,0,0,15,0,15,0,1,1,16,1,16,1,2,2,17,2,17,2,3,3,18,3,18,3,4,4,19,4,19,4,5,5,15,5,15,5,6,6,16,6,16,6,7,7,17,7,17,7,8,8,18,8,18,8,9,9,19,9,19,9,10,10,15,10,15,10,11,11,16,11,16,11,12,12,17,12,17,12,13,13,18,13,18,13,14,14,19,14,19,14,15,15,15,16,16,16,17,17,17,18,18,18,19,19,19,20,20,15,20,15,20,21,21,16,21,16,21,22,22,17,22,17,22,23,23,18,23,18,23,24,24,19,24,19,24,0,0,20,0,20,0,1,1,21,1,21,1,2,2,22,2,22,2,3,3,23,3,23,3,4,4,24,4,24,4,5,5,20,5,20,5,6,6,21,6,21,6,7,7,22,7,22,7,8,8,23,8,23,8,9,9,24,9,24,9,10,10,20,10,20,10,11,11,21,11,21,11,12,12,22,12,22,12,13,13,23,13,23,13,14,14,24,14,24,14,15,15,20,15,20,15,16,16,21,16,21,16,17,17,22,17,22,17,18,18,23,18,23,18,19,19,24,19,24,19,20,20,20,21,21,21,22,22,22,23,23,23,24,24,24)
#
clado_migration_rev = c(0,0,0,0,0,1,0,1,0,0,0,2,0,2,0,0,0,3,0,3,0,0,0,4,0,4,0,1,1,0,1,0,1,1,1,1,1,1,2,1,2,1,1,1,3,1,3,1,1,1,4,1,4,1,2,2,0,2,0,2,2,2,1,2,1,2,2,2,2,2,2,3,2,3,2,2,2,4,2,4,2,3,3,0,3,0,3,3,3,1,3,1,3,3,3,2,3,2,3,3,3,3,3,3,4,3,4,3,4,4,0,4,0,4,4,4,1,4,1,4,4,4,2,4,2,4,4,4,3,4,3,4,4,4,4)
#joint state-home-away locations lookup table for visitor model
joint_home_away_dat = data.frame(joint_state=NA,home_loc = NA, away_loc = NA)
for (i in 1:5){
for (j in 1:5)
joint_home_away_dat = rbind(joint_home_away_dat,c((i-1)*5+j-1,locs_vec[i],locs_vec[j]))
}
joint_home_away_dat = joint_home_away_dat[-1,]
# clado events for visitor model
clado_events_visitor = data.frame(clado_event = NA ,parent = NA, child_1 = NA, child_2 = NA,
home_parent = NA, away_parent = NA,
home_child1 = NA, away_child1 = NA,
home_child2 = NA, away_child2 = NA)
for (i in 1:225){
parent_joint_state = clado_visitor_rev[(i-1)*3+1] #parent's joint state
child1_joint_state = clado_visitor_rev[(i-1)*3+2] #child1's joint state
child2_joint_state = clado_visitor_rev[i*3] #child2's joint state
parent_home = joint_home_away_dat[joint_home_away_dat$joint_state==parent_joint_state,]$home_loc #parent's home loc
parent_away = joint_home_away_dat[joint_home_away_dat$joint_state==parent_joint_state,]$away_loc #parent's away loc
child1_home = joint_home_away_dat[joint_home_away_dat$joint_state==child1_joint_state,]$home_loc #child1's home loc
child1_away = joint_home_away_dat[joint_home_away_dat$joint_state==child1_joint_state,]$away_loc #child1's away loc
child2_home = joint_home_away_dat[joint_home_away_dat$joint_state==child2_joint_state,]$home_loc #child2's home loc
child2_away = joint_home_away_dat[joint_home_away_dat$joint_state==child2_joint_state,]$away_loc #child2's away loc
#
rows_added = c(i,clado_visitor_rev[((i-1)*3+1):(i*3)],parent_home,parent_away,child1_home,child1_away,child2_home,child2_away)
#
clado_events_visitor[i,] = rows_added
}
# clado events for clado migration model
clado_events_migration = data.frame(clado_event = NA ,parent = NA, child_1 = NA, child_2 = NA,
away_parent = NA,
away_child1 = NA,
away_child2 = NA)
for (i in 1:45){
parent_state = clado_migration_rev[(i-1)*3+1] #parent's state
child1_state = clado_migration_rev[(i-1)*3+2] #child1's state
child2_state = clado_migration_rev[i*3] #child2's state
parent_loc   = locs_vec[parent_state+1]
child1_loc   = locs_vec[child1_state+1]
child2_loc   = locs_vec[child2_state+1]
#
rows_added = c(i,parent_state,child1_state,child2_state,
parent_loc,child1_loc,child2_loc)
#
clado_events_migration[i,] = rows_added
}
#######
#resident-infects-resident class
#######
# in clado migration model: j -> j + j pattern
# in visitor model        : jj -> jj + jj pattern
# all resident-infects-resident clado events
clado_events_res_res <- clado_events_visitor[
clado_events_visitor$home_parent == clado_events_visitor$away_parent &
clado_events_visitor$home_child1 == clado_events_visitor$away_child1 &
clado_events_visitor$home_child2 == clado_events_visitor$away_child2 &
clado_events_visitor$away_parent == clado_events_visitor$away_child1 &
clado_events_visitor$away_parent == clado_events_visitor$away_child2,
]
names(clado_events_res_res)[1] <- "clado_event_visitor"
# add the clado event ordering from migration model for each event type in clado_events_res_res
clado_events_res_res <- cbind(clado_events_res_res[1], clado_event_migration = rep(NA,nrow(clado_events_res_res)),
clado_events_res_res[2:10],visitor_mean = rep(NA,nrow(clado_events_res_res)),
migration_mean = rep(NA,nrow(clado_events_res_res)),
visitor_lower = rep(NA,nrow(clado_events_res_res)),
visitor_upper = rep(NA,nrow(clado_events_res_res)),
migration_lower = rep(NA,nrow(clado_events_res_res)),
migration_upper = rep(NA,nrow(clado_events_res_res)))
#
clado_events_res_res = clado_events_res_res[,c(-3,-4,-5)]
for (i in 1:nrow(clado_events_res_res)){
clado_migration = clado_events_migration[clado_events_migration$away_parent == clado_events_res_res[i,]$away_parent &
clado_events_migration$away_child1 == clado_events_res_res[i,]$away_child1 &
clado_events_migration$away_child2 == clado_events_res_res[i,]$away_child2,]$clado_event
#
clado_events_res_res$clado_event_migration[i] = clado_migration
}
# get the posterior means and 95% HPD for res-res infections class from both models
for (i in 1:nrow(clado_events_res_res)){
# get posterior mean and 95% HPD interval for that clado event from visitor model
which_clado_visitor = paste0("clado_rates.",clado_events_res_res$clado_event_visitor[i],".")
visitor_mean    = mean(dat_visitor[[which_clado_visitor]])
visitor_lower   = as.numeric(hdi(dat_visitor[[which_clado_visitor]])[1])
visitor_upper   = as.numeric(hdi(dat_visitor[[which_clado_visitor]])[2])
# get posterior mean and 95% HPD interval for that clado event from migration model
which_clado_migration = paste0("clado_rates.",clado_events_res_res$clado_event_migration[i],".")
migration_mean  = mean(dat_clado[[which_clado_migration]])
migration_lower = as.numeric(hdi(dat_clado[[which_clado_migration]])[1])
migration_upper = as.numeric(hdi(dat_clado[[which_clado_migration]])[2])
#
clado_events_res_res$visitor_mean[i]    = visitor_mean
clado_events_res_res$visitor_lower[i]   = visitor_lower
clado_events_res_res$visitor_upper[i]   = visitor_upper
clado_events_res_res$migration_mean[i]  = migration_mean
clado_events_res_res$migration_lower[i] = migration_lower
clado_events_res_res$migration_upper[i] = migration_upper
}
#######
#resident-infects-visitor class
#######
# in clado migration model: j -> j + i pattern (i is visitor & j is resident here)
# in visitor model        : jj -> jj + ij pattern
# all resident-infects-visitor clado events
# this is for jj -> jj + ij pattern
right_pattern_visit = clado_events_visitor[clado_events_visitor$home_parent == clado_events_visitor$away_parent &
clado_events_visitor$home_parent == clado_events_visitor$home_child1 &
clado_events_visitor$away_parent == clado_events_visitor$away_child1 &
clado_events_visitor$home_parent != clado_events_visitor$home_child2,]
# this is for jj -> ij + jj pattern
left_pattern_visit = clado_events_visitor[clado_events_visitor$home_parent == clado_events_visitor$away_parent &
clado_events_visitor$home_parent == clado_events_visitor$home_child2 &
clado_events_visitor$away_parent == clado_events_visitor$away_child2 &
clado_events_visitor$home_parent != clado_events_visitor$home_child1,]
clado_events_res_vis <- rbind(right_pattern_visit,left_pattern_visit)
names(clado_events_res_vis)[1] <- "clado_event_visitor"
# add the clado event ordering from migration model for each event type in clado_events_res_vis
# j -> j + i and j -> i + j patterns
clado_events_res_vis <- cbind(clado_events_res_vis[1], clado_event_migration = rep(NA,nrow(clado_events_res_vis)),
clado_events_res_vis[2:10],visitor_mean = rep(NA,nrow(clado_events_res_vis)),
migration_mean = rep(NA,nrow(clado_events_res_vis)),
visitor_lower = rep(NA,nrow(clado_events_res_vis)),
visitor_upper = rep(NA,nrow(clado_events_res_vis)),
migration_lower = rep(NA,nrow(clado_events_res_vis)),
migration_upper = rep(NA,nrow(clado_events_res_vis)))
#
clado_events_res_vis = clado_events_res_vis[,c(-3,-4,-5)]
for (i in 1:nrow(clado_events_res_vis)){
clado_migration = clado_events_migration[clado_events_migration$away_parent == clado_events_res_vis[i,]$home_parent &
clado_events_migration$away_child1 == clado_events_res_vis[i,]$home_child1 &
clado_events_migration$away_child2 == clado_events_res_vis[i,]$home_child2,]$clado_event
#
clado_events_res_vis$clado_event_migration[i] = clado_migration
}
# ignore left-right inheritance of children lineages from clado_events_res_vis
# e.g. only consider (j,j) -> (j,j) + (i,j) instead of with (j,j) -> (i,j) + (j,j)
clado_events_res_vis = clado_events_res_vis[1:20,]
# get the posterior means and 95% HPD for res-vis infections class from both models
for (i in 1:nrow(clado_events_res_vis)){
# get posterior mean and 95% HPD interval for that clado event from visitor model
which_clado_visitor = paste0("clado_rates.",clado_events_res_vis$clado_event_visitor[i],".")
visitor_mean    = mean(2*dat_visitor[[which_clado_visitor]]) #multiply the rates by 2 for left-right
visitor_lower   = as.numeric(hdi(2*dat_visitor[[which_clado_visitor]])[1]) #multiply the rates by 2 for left-right
visitor_upper   = as.numeric(hdi(2*dat_visitor[[which_clado_visitor]])[2]) #multiply the rates by 2 for left-right
# get posterior mean and 95% HPD interval for that clado event from migration model
which_clado_migration = paste0("clado_rates.",clado_events_res_vis$clado_event_migration[i],".")
migration_mean  = mean(2*dat_clado[[which_clado_migration]])
migration_lower = as.numeric(hdi(2*dat_clado[[which_clado_migration]])[1])
migration_upper = as.numeric(hdi(2*dat_clado[[which_clado_migration]])[2])
#
clado_events_res_vis$visitor_mean[i]    = visitor_mean
clado_events_res_vis$visitor_lower[i]   = visitor_lower
clado_events_res_vis$visitor_upper[i]   = visitor_upper
clado_events_res_vis$migration_mean[i]  = migration_mean
clado_events_res_vis$migration_lower[i] = migration_lower
clado_events_res_vis$migration_upper[i] = migration_upper
}
#######
#visitor-infects-resident class
#######
# in clado migration model: j -> j + i pattern (i is visitor & j is resident here)
# in visitor model        : ij -> jj + ij pattern
# all visitor-infects-resident clado events
# this is for ij -> ij + jj pattern
right_pattern_visit = clado_events_visitor[clado_events_visitor$home_parent != clado_events_visitor$away_parent &
clado_events_visitor$home_parent == clado_events_visitor$home_child1 &
clado_events_visitor$away_parent == clado_events_visitor$away_child1 &
clado_events_visitor$home_parent != clado_events_visitor$home_child2 &
clado_events_visitor$home_child2 == clado_events_visitor$away_child2,]
# this is for ij -> jj + ij pattern
left_pattern_visit = clado_events_visitor[clado_events_visitor$home_parent != clado_events_visitor$away_parent &
clado_events_visitor$home_parent == clado_events_visitor$home_child2 &
clado_events_visitor$away_parent == clado_events_visitor$away_child2 &
clado_events_visitor$home_parent != clado_events_visitor$home_child1 &
clado_events_visitor$home_child1 == clado_events_visitor$away_child1,]
clado_events_vis_res <- rbind(right_pattern_visit,left_pattern_visit)
names(clado_events_vis_res)[1] <- "clado_event_visitor"
# add the clado event ordering from migration model for each event type in clado_events_vis_res
# j -> j + i and j -> i + j patterns
clado_events_vis_res <- cbind(clado_events_vis_res[1], clado_event_migration = rep(NA,nrow(clado_events_vis_res)),
clado_events_vis_res[2:10],visitor_mean = rep(NA,nrow(clado_events_vis_res)),
migration_mean = rep(NA,nrow(clado_events_vis_res)),
visitor_lower = rep(NA,nrow(clado_events_vis_res)),
visitor_upper = rep(NA,nrow(clado_events_vis_res)),
migration_lower = rep(NA,nrow(clado_events_vis_res)),
migration_upper = rep(NA,nrow(clado_events_vis_res)))
#
clado_events_vis_res = clado_events_vis_res[,c(-3,-4,-5)]
for (i in 1:nrow(clado_events_vis_res)){
clado_migration = clado_events_migration[clado_events_migration$away_parent == clado_events_vis_res[i,]$away_parent &
clado_events_migration$away_child1 == clado_events_vis_res[i,]$home_child1 &
clado_events_migration$away_child2 == clado_events_vis_res[i,]$home_child2,]$clado_event
#
clado_events_vis_res$clado_event_migration[i] = clado_migration
}
# ignore left-right inheritance of children lineages from clado_events_vis_res
# e.g. only consider (i,j) -> (i,j) + (j,j) instead of with (i,j) -> (j,j) + (i,j)
clado_events_vis_res = clado_events_vis_res[1:20,]
# get the posterior means and 95% HPD for vis-res infections class from both models
for (i in 1:nrow(clado_events_vis_res)){
# get posterior mean and 95% HPD interval for that clado event from visitor model
which_clado_visitor = paste0("clado_rates.",clado_events_vis_res$clado_event_visitor[i],".")
visitor_mean    = mean(2*dat_visitor[[which_clado_visitor]]) #multiply the rates by 2 for left-right
visitor_lower   = as.numeric(hdi(2*dat_visitor[[which_clado_visitor]])[1]) #multiply the rates by 2 for left-right
visitor_upper   = as.numeric(hdi(2*dat_visitor[[which_clado_visitor]])[2]) #multiply the rates by 2 for left-right
# get posterior mean and 95% HPD interval for that clado event from migration model
which_clado_migration = paste0("clado_rates.",clado_events_vis_res$clado_event_migration[i],".")
migration_mean  = mean(2*dat_clado[[which_clado_migration]])
migration_lower = as.numeric(hdi(2*dat_clado[[which_clado_migration]])[1])
migration_upper = as.numeric(hdi(2*dat_clado[[which_clado_migration]])[2])
#
clado_events_vis_res$visitor_mean[i]    = visitor_mean
clado_events_vis_res$visitor_lower[i]   = visitor_lower
clado_events_vis_res$visitor_upper[i]   = visitor_upper
clado_events_vis_res$migration_mean[i]  = migration_mean
clado_events_vis_res$migration_lower[i] = migration_lower
clado_events_vis_res$migration_upper[i] = migration_upper
}
# set factor for away parent's locations
clado_events_res_res$away_parent = factor(clado_events_res_res$away_parent, levels = c("Hubei","France","Germany","Italy","OtherEU"))
clado_events_res_vis$away_parent = factor(clado_events_res_vis$away_parent, levels = c("Hubei","France","Germany","Italy","OtherEU"))
clado_events_vis_res$away_parent = factor(clado_events_vis_res$away_parent, levels = c("Hubei","France","Germany","Italy","OtherEU"))
######
#Plotting
p_res_res = ggplot(clado_events_res_res, aes(x = visitor_mean, y = migration_mean, color = away_parent)) +
geom_point(size = 3)
p_res_res = p_res_res + geom_segment(aes(x = visitor_mean, xend = visitor_mean,
y = migration_lower, yend = migration_upper),
linewidth = 0.6)
p_res_res = p_res_res + geom_segment(aes(x = visitor_lower, xend = visitor_upper,
y = migration_mean, yend = migration_mean),
linewidth = 0.6)
p_res_res = p_res_res + geom_abline(intercept=0, slope=1, lty=2, color="gray") + scale_x_log10(limits = c(0.02,0.40))  + scale_y_log10(limits = c(0.02,0.40))
p_res_res = p_res_res + xlab("Visitor SIR Infection Rate") + ylab("Migration SIR Infection Rate") + labs(title = "Resident-Infects-Resident Class", color = "Infection location")+
theme_minimal() +
theme(axis.text.x = element_text(size = 20),   # x-axis tick labels
axis.text.y = element_text(size = 20),
axis.title.x = element_text(size = 20),       # x-axis title
axis.title.y = element_text(size = 20),       # y-axis title
legend.text = element_text(size = 18),   # legend item labels
legend.title = element_text(size = 24),
plot.title = element_text(hjust = 0.5, size = 24)
)    # y-axis tick labels
####
# Some of the upper bounds from the visitor model are outside the limit of y axis
# I keep those points using oob_keep
p_res_vis = ggplot(clado_events_res_vis, aes(x = visitor_mean, y = migration_mean, color = away_parent)) +
geom_point(size = 3)
p_res_vis = p_res_vis + geom_segment(aes(x = visitor_mean, xend = visitor_mean,
y = migration_lower, yend = migration_upper),
linewidth = 0.6)
p_res_vis = p_res_vis + geom_segment(aes(x = visitor_lower, xend = visitor_upper,
y = migration_mean, yend = migration_mean),
linewidth = 0.6)
p_res_vis = p_res_vis + geom_abline(intercept=0, slope=1, lty=2, color="gray") + scale_x_log10(limits = c(10^-9,1))  + scale_y_log10(limits = c(10^-9,1))
p_res_vis = p_res_vis +  xlab("Visitor SIR Infection Rate") + ylab("Migration SIR Infection Rate") + labs(title = "Resident-Infects-Visitor Class", color = "Infection location")+
theme_minimal() +
theme(axis.text.x = element_text(size = 20),   # x-axis tick labels
axis.text.y = element_text(size = 20),
axis.title.x = element_text(size = 20),       # x-axis title
axis.title.y = element_text(size = 20),       # y-axis title
legend.text = element_text(size = 18),   # legend item labels
legend.title = element_text(size = 24),
plot.title = element_text(hjust = 0.5, size = 24)
)    # y-axis tick labels
####
p_vis_res = ggplot(clado_events_vis_res, aes(x = visitor_mean, y = migration_mean, color = away_parent)) +
geom_point(size = 3)
p_vis_res = p_vis_res + geom_segment(aes(x = visitor_mean, xend = visitor_mean,
y = migration_lower, yend = migration_upper),
linewidth = 0.6)
p_vis_res = p_vis_res + geom_segment(aes(x = visitor_lower, xend = visitor_upper,
y = migration_mean, yend = migration_mean),
linewidth = 0.6)
p_vis_res = p_vis_res + geom_abline(intercept=0, slope=1, lty=2, color="gray") + scale_x_log10(limits = c(10^-4,0.4))  + scale_y_log10(limits = c(10^-4,0.4))
p_vis_res = p_vis_res +  xlab("Visitor SIR Infection Rate") + ylab("Migration SIR Infection Rate") + labs(title = "Visitor-Infects-Resident Class", color = "Infection location")+
theme_minimal() +
theme(axis.text.x = element_text(size = 20),   # x-axis tick labels
axis.text.y = element_text(size = 20),
axis.title.x = element_text(size = 20),       # x-axis title
axis.title.y = element_text(size = 20),       # y-axis title
legend.text = element_text(size = 18),   # legend item labels
legend.title = element_text(size = 24),
plot.title = element_text(hjust = 0.5, size = 24)
)# y-axis tick labels
plot_res_res = paste0(plot_fp, "/plot_res_res.pdf")
print(plot_res_res)
pdf(plot_res_res, height=7, width=10)
print(p_res_res)
dev.off()
plot_res_vis = paste0(plot_fp, "/plot_res_vis.pdf")
print(plot_res_vis)
pdf(plot_res_vis, height=7, width=10)
print(p_res_vis)
dev.off()
plot_vis_res = paste0(plot_fp, "/plot_vis_res.pdf")
print(plot_vis_res)
pdf(plot_vis_res, height=7, width=10)
print(p_vis_res)
dev.off()
